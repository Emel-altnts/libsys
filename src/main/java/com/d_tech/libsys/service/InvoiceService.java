package com.d_tech.libsys.service;

import com.d_tech.libsys.domain.model.Invoice;
import com.d_tech.libsys.domain.model.StockOrder;
import com.d_tech.libsys.dto.InvoiceEvent;
import com.d_tech.libsys.dto.InvoiceRequest;
import com.d_tech.libsys.repository.InvoiceRepository;
import com.d_tech.libsys.repository.StockOrderRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.UUID;
import java.util.concurrent.CompletableFuture;

/**
 * ðŸš€ CORRECTED: Fatura yÃ¶netim servisi - Method signature dÃ¼zeltildi
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class InvoiceService {

    private final InvoiceRepository invoiceRepository;
    private final StockOrderRepository stockOrderRepository;
    private final KafkaProducerService kafkaProducerService;

    /**
     * ðŸš€ FIXED: Asenkron fatura oluÅŸturma - doÄŸru method signature
     */
    public CompletableFuture<String> generateInvoiceAsync(Long orderId, InvoiceRequest invoiceRequest) {
        log.info("Asenkron fatura oluÅŸturma baÅŸlatÄ±lÄ±yor: orderId={}", orderId);

        try {
            // Temel validasyonlar
            validateInvoiceRequest(orderId, invoiceRequest);

            // Event oluÅŸtur
            InvoiceEvent event = InvoiceEvent.builder()
                    .eventId(generateEventId("GENERATE_INVOICE"))
                    .eventType(InvoiceEvent.EventType.GENERATE_INVOICE)
                    .orderId(orderId)
                    .invoiceRequest(invoiceRequest)
                    .build();

            // Kafka'ya gÃ¶nder
            return kafkaProducerService.sendInvoiceEvent(event)
                    .thenApply(success -> {
                        if (success) {
                            log.info("Fatura oluÅŸturma event'i gÃ¶nderildi: eventId={}", event.getEventId());
                            return event.getEventId();
                        } else {
                            log.error("Fatura oluÅŸturma event'i gÃ¶nderilemedi: orderId={}", orderId);
                            throw new RuntimeException("Fatura oluÅŸturma event'i gÃ¶nderilemedi");
                        }
                    });

        } catch (Exception e) {
            log.error("Asenkron fatura oluÅŸturma hatasÄ±: orderId={}, error={}", orderId, e.getMessage(), e);
            return CompletableFuture.failedFuture(e);
        }
    }

    /**
     * ðŸš€ FIXED: Fatura Ã¶dendi iÅŸareti - doÄŸru method signature
     */
    public CompletableFuture<String> markInvoiceAsPaidAsync(Long invoiceId, String paymentMethod, String userId) {
        log.info("Fatura Ã¶dendi olarak iÅŸaretleniyor: invoiceId={}, paymentMethod={}", invoiceId, paymentMethod);

        try {
            InvoiceEvent event = InvoiceEvent.builder()
                    .eventId(generateEventId("MARK_PAID"))
                    .eventType(InvoiceEvent.EventType.MARK_PAID)
                    .message("Payment method: " + paymentMethod + ", User: " + userId)
                    .build();

            return kafkaProducerService.sendInvoiceEvent(event)
                    .thenApply(success -> {
                        if (success) {
                            log.info("Fatura Ã¶deme event'i gÃ¶nderildi: eventId={}", event.getEventId());
                            return event.getEventId();
                        } else {
                            throw new RuntimeException("Fatura Ã¶deme event'i gÃ¶nderilemedi");
                        }
                    });

        } catch (Exception e) {
            log.error("Fatura Ã¶deme hatasÄ±: invoiceId={}, error={}", invoiceId, e.getMessage(), e);
            return CompletableFuture.failedFuture(e);
        }
    }

    /**
     * ðŸš€ ENHANCED: Fatura oluÅŸturma - Transaction yÃ¶netimi iyileÅŸtirildi
     */
    @Transactional
    public Invoice generateInvoice(Long orderId, InvoiceRequest invoiceRequest) {
        log.info("Fatura oluÅŸturuluyor: orderId={}", orderId);

        // SipariÅŸ kontrolÃ¼ - JOIN FETCH ile
        StockOrder order = stockOrderRepository.findById(orderId)
                .orElseThrow(() -> new IllegalArgumentException("SipariÅŸ bulunamadÄ±: " + orderId));

        // Zaten fatura var mÄ± kontrol et
        if (invoiceRepository.findByStockOrderId(orderId).isPresent()) {
            throw new IllegalStateException("Bu sipariÅŸ iÃ§in zaten fatura mevcut: " + orderId);
        }

        // SipariÅŸ tamamlandÄ± mÄ± kontrol et
        if (!order.isCompleted()) {
            throw new IllegalStateException("SipariÅŸ henÃ¼z tamamlanmadÄ±: " + order.getStatus());
        }

        // Fatura numarasÄ± oluÅŸtur
        String invoiceNumber = generateInvoiceNumber();

        // Fatura oluÅŸtur
        Invoice invoice = Invoice.builder()
                .invoiceNumber(invoiceNumber)
                .stockOrder(order)
                .dueDate(invoiceRequest.getDueDate() != null ?
                        invoiceRequest.getDueDate() :
                        LocalDateTime.now().plusDays(30))
                .supplierName(order.getSupplierName())
                .supplierAddress(invoiceRequest.getSupplierAddress())
                .supplierTaxNumber(invoiceRequest.getSupplierTaxNumber())
                .supplierPhone(invoiceRequest.getSupplierPhone())
                .supplierEmail(invoiceRequest.getSupplierEmail())
                .buyerName(invoiceRequest.getBuyerName() != null ?
                        invoiceRequest.getBuyerName() :
                        "D-Tech KÃ¼tÃ¼phane Sistemi")
                .buyerAddress(invoiceRequest.getBuyerAddress())
                .buyerTaxNumber(invoiceRequest.getBuyerTaxNumber())
                .notes(invoiceRequest.getNotes())
                .createdBy(invoiceRequest.getCreatedBy())
                .build();

        // SipariÅŸ tutarlarÄ±nÄ± kopyala
        invoice.copyAmountsFromOrder();

        // FaturayÄ± kaydet
        Invoice savedInvoice = invoiceRepository.save(invoice);

        log.info("Fatura oluÅŸturuldu: invoiceId={}, invoiceNumber={}, total={}",
                savedInvoice.getId(), savedInvoice.getInvoiceNumber(), savedInvoice.getGrandTotal());

        return savedInvoice;
    }

    /**
     * ðŸš€ CRITICAL FIX: SipariÅŸ ID'siyle fatura getir - Lazy Loading Ã§Ã¶zÃ¼ldÃ¼
     */
    @Transactional(readOnly = true)
    public Optional<Invoice> getInvoiceByOrderId(Long orderId) {
        log.info("SipariÅŸ faturasÄ± sorgulanÄ±yor: orderId={}", orderId);

        try {
            // Ã–nce basit sorguyu dene
            Optional<Invoice> invoiceOpt = invoiceRepository.findByStockOrderId(orderId);

            if (invoiceOpt.isPresent()) {
                Invoice invoice = invoiceOpt.get();
                log.info("Fatura bulundu: invoiceId={}, invoiceNumber={}, orderId={}",
                        invoice.getId(), invoice.getInvoiceNumber(), orderId);
                return invoiceOpt;
            }

            log.warn("SipariÅŸ faturasÄ± bulunamadÄ±: orderId={}", orderId);
            return Optional.empty();

        } catch (Exception e) {
            log.error("Fatura sorgulama hatasÄ±: orderId={}, error={}", orderId, e.getMessage(), e);
            return Optional.empty();
        }
    }

    /**
     * Senkron fatura Ã¶deme iÅŸareti (Consumer tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r)
     */
    @Transactional
    public Invoice markInvoiceAsPaid(Long invoiceId, String paymentMethod) {
        log.info("Fatura Ã¶dendi olarak iÅŸaretleniyor: invoiceId={}", invoiceId);

        Invoice invoice = invoiceRepository.findById(invoiceId)
                .orElseThrow(() -> new IllegalArgumentException("Fatura bulunamadÄ±: " + invoiceId));

        if (invoice.getPaymentStatus() == Invoice.PaymentStatus.PAID) {
            throw new IllegalStateException("Fatura zaten Ã¶denmiÅŸ: " + invoiceId);
        }

        invoice.markAsPaid(paymentMethod);
        Invoice paidInvoice = invoiceRepository.save(invoice);

        log.info("Fatura Ã¶dendi olarak iÅŸaretlendi: invoiceId={}, paymentDate={}",
                invoiceId, paidInvoice.getPaymentDate());

        return paidInvoice;
    }

    /**
     * âœ… BASIC METHODS - KullanÄ±lan metodlar
     */

    @Transactional(readOnly = true)
    public Optional<Invoice> getInvoiceById(Long invoiceId) {
        return invoiceRepository.findById(invoiceId);
    }

    @Transactional(readOnly = true)
    public Optional<Invoice> getInvoiceByNumber(String invoiceNumber) {
        return invoiceRepository.findByInvoiceNumber(invoiceNumber);
    }

    public List<Invoice> getInvoicesByPaymentStatus(Invoice.PaymentStatus paymentStatus) {
        return invoiceRepository.findByPaymentStatus(paymentStatus);
    }

    public List<Invoice> getOverdueInvoices() {
        return invoiceRepository.findOverdueInvoices(LocalDateTime.now());
    }

    public List<Invoice> getInvoicesBySupplier(String supplierName) {
        return invoiceRepository.findBySupplierNameContainingIgnoreCase(supplierName);
    }

    public List<Invoice> getInvoicesByUser(String userId) {
        return invoiceRepository.findByCreatedByOrderByInvoiceDateDesc(userId);
    }

    public Double getTotalUnpaidAmount() {
        return invoiceRepository.calculateTotalUnpaidAmount();
    }

    public Double getTotalInvoiceAmount(LocalDateTime startDate, LocalDateTime endDate) {
        return invoiceRepository.calculateTotalInvoiceAmount(startDate, endDate);
    }

    /**
     * Fatura iptal etme
     */
    @Transactional
    public Invoice cancelInvoice(Long invoiceId, String reason) {
        log.info("Fatura iptal ediliyor: invoiceId={}, reason={}", invoiceId, reason);

        Invoice invoice = invoiceRepository.findById(invoiceId)
                .orElseThrow(() -> new IllegalArgumentException("Fatura bulunamadÄ±: " + invoiceId));

        if (invoice.getPaymentStatus() == Invoice.PaymentStatus.PAID) {
            throw new IllegalStateException("Ã–denmiÅŸ fatura iptal edilemez: " + invoiceId);
        }

        invoice.setPaymentStatus(Invoice.PaymentStatus.CANCELLED);
        invoice.setNotes(invoice.getNotes() + " | Ä°ptal nedeni: " + reason);

        Invoice cancelledInvoice = invoiceRepository.save(invoice);
        log.info("Fatura iptal edildi: invoiceId={}", invoiceId);

        return cancelledInvoice;
    }

    /**
     * Fatura gÃ¼ncelleme
     */
    @Transactional
    public Invoice updateInvoice(Long invoiceId, InvoiceRequest updateRequest) {
        log.info("Fatura gÃ¼ncelleniyor: invoiceId={}", invoiceId);

        Invoice invoice = invoiceRepository.findById(invoiceId)
                .orElseThrow(() -> new IllegalArgumentException("Fatura bulunamadÄ±: " + invoiceId));

        if (invoice.getPaymentStatus() == Invoice.PaymentStatus.PAID) {
            throw new IllegalStateException("Ã–denmiÅŸ fatura gÃ¼ncellenemez: " + invoiceId);
        }

        // GÃ¼ncelleme
        if (updateRequest.getDueDate() != null) invoice.setDueDate(updateRequest.getDueDate());
        if (updateRequest.getSupplierAddress() != null) invoice.setSupplierAddress(updateRequest.getSupplierAddress());
        if (updateRequest.getSupplierTaxNumber() != null) invoice.setSupplierTaxNumber(updateRequest.getSupplierTaxNumber());
        if (updateRequest.getSupplierPhone() != null) invoice.setSupplierPhone(updateRequest.getSupplierPhone());
        if (updateRequest.getSupplierEmail() != null) invoice.setSupplierEmail(updateRequest.getSupplierEmail());
        if (updateRequest.getBuyerName() != null) invoice.setBuyerName(updateRequest.getBuyerName());
        if (updateRequest.getBuyerAddress() != null) invoice.setBuyerAddress(updateRequest.getBuyerAddress());
        if (updateRequest.getBuyerTaxNumber() != null) invoice.setBuyerTaxNumber(updateRequest.getBuyerTaxNumber());
        if (updateRequest.getNotes() != null) invoice.setNotes(updateRequest.getNotes());

        Invoice updatedInvoice = invoiceRepository.save(invoice);
        log.info("Fatura gÃ¼ncellendi: invoiceId={}", invoiceId);

        return updatedInvoice;
    }

    /**
     * âœ… PRIVATE HELPER METHODS
     */

    private void validateInvoiceRequest(Long orderId, InvoiceRequest invoiceRequest) {
        if (orderId == null) {
            throw new IllegalArgumentException("SipariÅŸ ID'si boÅŸ olamaz");
        }

        if (invoiceRequest.getCreatedBy() == null || invoiceRequest.getCreatedBy().trim().isEmpty()) {
            throw new IllegalArgumentException("Fatura oluÅŸturan kiÅŸi bilgisi boÅŸ olamaz");
        }
    }

    private String generateInvoiceNumber() {
        String invoiceNumber;
        do {
            invoiceNumber = Invoice.generateInvoiceNumber();
        } while (invoiceRepository.existsByInvoiceNumber(invoiceNumber));

        return invoiceNumber;
    }

    private String generateEventId(String prefix) {
        return prefix + "_" + System.currentTimeMillis() + "_" + UUID.randomUUID().toString().substring(0, 8);
    }
}